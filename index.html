<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Console Vorie</title>
<style>
  :root{--bg:#0b1220;--card:#0f1724;--muted:#9fb0c8;--text:#e6eef8;--accent:#60a5fa;--soft:#0b1a2a;--transition:280ms}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071227,#04101a);color:var(--text);-webkit-font-smoothing:antialiased}
  header{height:56px;display:flex;align-items:center;gap:12px;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .hamburger{width:44px;height:44px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition)}
  .hamburger .bars{width:18px;height:2px;background:var(--text);position:relative}
  .hamburger .bars:before,.hamburger .bars:after{content:"";position:absolute;left:0;width:18px;height:2px;background:var(--text)}
  .hamburger .bars:before{top:-6px} .hamburger .bars:after{top:6px}
  .app{display:flex;height:calc(100vh - 56px);overflow:hidden}
  .sidebar{position:fixed;left:0;top:56px;bottom:0;width:320px;background:var(--card);backdrop-filter:blur(6px);transform:translateX(-110%);transition:transform var(--transition);padding:12px;border-right:1px solid rgba(255,255,255,0.02);z-index:60;border-top-right-radius:12px;border-bottom-right-radius:12px}
  .sidebar.open{transform:translateX(0)}
  .menu{display:flex;flex-direction:column;gap:8px}
  .menu button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer;text-align:left}
  .menu button.active{background:linear-gradient(90deg, rgba(96,165,250,0.08), transparent)}
  .content{flex:1;margin-left:0;display:flex;flex-direction:column;height:100%;transition:margin-left var(--transition)}
  .content.shift{margin-left:320px}
  .main{display:flex;flex-direction:column;gap:12px;padding:12px;height:100%;box-sizing:border-box}
  textarea,select,input,button{font-family:inherit}
  textarea#code{flex:1;width:100%;min-height:260px;border-radius:10px;padding:12px;font-family:ui-monospace, Menlo, Monaco, monospace;background:var(--soft);color:var(--text);border:1px solid rgba(255,255,255,0.03);resize:vertical}
  .panel{max-width:100%;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
  pre.output{background:#071224;padding:10px;border-radius:8px;color:#cfeffd;min-height:120px;white-space:pre-wrap;word-break:break-word}
  iframe.preview{width:100%;height:320px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
  .files-list{max-height:360px;overflow:auto;border-radius:6px;padding:6px;background:rgba(255,255,255,0.02)}
  .file-item{padding:8px;border-radius:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:880px){ .sidebar{width:84%} }
  .fade-in{animation:fadeIn 260ms ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .badge{font-size:11px;padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer}
</style>
</head>
<body>
<header>
  <button id="hamburger" class="hamburger" aria-label="Toggle menu"><span class="bars"></span></button>
  <div>
    <div style="font-weight:600">VORIE Online IDE</div>
    <div class="small">Multi-language • Made With ❤️ By Xgtib</div>
  </div>
  <div style="flex:1"></div>
  <div class="small" style="margin-right:10px">Ctrl/Cmd+Enter → Run</div>
</header>

<div class="app">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div style="display:flex;flex-direction:column;height:100%">
      <div style="margin-bottom:8px"><div class="small" style="margin-bottom:6px">Fitur</div>
        <div class="menu">
          <button data-section="editor" class="active">Editor</button>
          <button data-section="files">File Manager</button>
          <button data-section="calc">Calculator</button>
          <button data-section="chat">ChatGPT</button>
          <button data-section="Vor">More Project</button>
        </div>
      </div>

      <div style="margin-top:auto">
        <div class="small" style="margin-bottom:8px">Theme</div>
        <div style="display:flex;gap:8px">
          <button id="themeToggle" class="btn">Toggle Theme</button>
          <div style="flex:1"></div>
          <div class="small">v1.0</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Content -->
  <main id="content" class="content">
    <div class="main">

      <!-- EDITOR VIEW -->
      <section id="view-editor" class="panel fade-in">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <label class="small">Language</label>
          <select id="lang">
            <option value="cpp">C++</option><option value="c">C</option><option value="python">Python</option><option value="java">Java</option><option value="js">JavaScript</option><option value="html">HTML/CSS/JS</option>
          </select>
          <button id="runBtn" class="btn">▶ Run</button>
          <button id="stopBtn" class="btn">■ Stop</button>
          <button id="downloadBtn" class="btn">⬇ Download</button>
          <div style="flex:1"></div>
          <label class="small">Preview</label>
          <select id="previewMode"><option value="auto">Auto</option><option value="console">Console</option><option value="html">HTML</option></select>
        </div>

        <textarea id="code">// VORIE IDE: Pilih bahasa lalu Run. Ctrl/Cmd+Enter untuk menjalankan.
#include &lt;iostream&gt;
using namespace std;
int main(){ cout<<\"Hello Vorie!\\n\"; return 0; }</textarea>

        <div style="margin-top:12px">
          <div class="small" style="margin-bottom:6px">Output</div>
          <pre id="output" class="output">— output akan muncul di sini —</pre>
        </div>

        <div id="htmlPreview" style="display:none;margin-top:12px">
          <div class="small">HTML Preview</div>
          <iframe id="preview" class="preview"></iframe>
        </div>
      </section>

      <!-- FILES VIEW -->
      <section id="view-files" class="panel" style="display:none">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <div style="flex:1">
            <div class="small" style="margin-bottom:6px">File Manager</div>
            <input id="search" placeholder="Cari lokal / remote..." style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)"/>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div class="small">Remote</div>
            <div class="small badge" id="remoteStatus">—</div>
          </div>
        </div>

        <!-- Quick Actions (only in File Manager) -->
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <input id="fileInput" type="file" />
          <button id="uploadBtn" class="btn">Upload</button>
          <input id="saveAs" placeholder="Nama file ex: hello.cpp" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);flex:1"/>
          <button id="saveBtn" class="btn">Save</button>
          <button id="exportBtn" class="btn">Export</button>
          <input id="importFile" type="file" style="display:none"/>
          <button id="importBtn" class="btn">Import</button>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div class="files-list" id="filesList"></div>
          </div>
          <div style="width:300px">
            <div class="small" style="margin-bottom:6px">Selected File Preview</div>
            <pre id="filePreview" style="background:var(--soft);padding:10px;border-radius:8px;min-height:200px">—</pre>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="importToLocal" class="btn">Import Remote → Local</button>
              <button id="downloadSelected" class="btn">Download Selected</button>
            </div>
          </div>
        </div>
      </section>

      <!-- CALC VIEW -->
      <section id="view-calc" class="panel" style="display:none">
        <div class="small" style="margin-bottom:8px">Calculator (math.js)</div>
        <input id="calcInput" placeholder="Contoh: 2*(3+4) - sqrt(16)" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)"/>
        <div id="ops" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="calcEval" class="btn">= Evaluate</button><button id="calcClear" class="btn">C</button></div>
        <pre id="calcResult" style="margin-top:8px;background:var(--soft);padding:8px;border-radius:8px">—</pre>
      </section>

      <!-- CHAT VIEW -->
      <section id="view-chat" class="panel" style="display:none">
        <div class="small" style="margin-bottom:8px">ChatGPT</div>
        <textarea id="chatMsg" rows="4" placeholder="Tanya ChatGPT..." style="width:100%;padding:8px;border-radius:8px;background:transparent;color:var(--text)"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="chatSend" class="btn">Kirim</button>
          <button id="chatClear" class="btn">Clear</button>
        </div>
        <pre id="chatResp" style="margin-top:8px;background:var(--soft);padding:8px;border-radius:8px">—</pre>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-vor" class="panel" style="display:none">
        <div class="small" style="margin-bottom:8px">More Project By Xgtib</div>
        <div style="display:grid;grid-template-columns:1fr;gap:8px">
          <h1>Another Project By Xgtib</h1>
             <p>Mau Buat Website? Ke</p> <a href="tokovorie.xgtib.my.id">Toko Vorie</a>
              <a href="gxostore.netlify.app">GxoStore</a>
              <a href="vorcv.xgtib.my.id">VorCv For Vcf</a>
              <a href="gxotopup.xgtib.my.id">Top Up ML</a>
              <a href="api.xgtib.my.id">API's Xgtib</a>
          <div class="small">Catatan: Keys disimpan lokal di browser. Jangan pakai key sensitif di perangkat umum.</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLoadRemote" class="btn">Load remote index now</button>
          <button id="btnClearLocal" class="btn">Clear local index</button>
        </div>
      </section>

    </div>
  </main>
</div>

<footer style="position:fixed;left:0;right:0;bottom:0;padding:8px 12px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.18));font-size:12px;color:var(--muted)">
  VORIE Online IDE • Made With ♥️ By Xgtib
</footer>

<script>
/* =========================
   VORIE Online IDE - FINAL
   Features:
   - Single-file SPA (Mode B)
   - File Manager auto-save local -> jsonbin -> judge0 (optional)
   - Remote JSONBin search + import
   - Quick Actions only in File Manager
   ========================= */

/* Utilities */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const randId = () => 'id-' + Math.random().toString(36).slice(2,9);
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function toast(m){ const o=$('#output'); o.textContent = (new Date()).toISOString() + ' › ' + m + '\\n' + o.textContent; }

/* Elements & state */
const hamburger = $('#hamburger'), sidebar = $('#sidebar'), content = $('#content');
const menuButtons = $$('.menu button');
const views = {
  editor: $('#view-editor'), files: $('#view-files'), calc: $('#view-calc'), chat: $('#view-chat'), settings: $('#view-settings')
};
const langEl = $('#lang'), runBtn = $('#runBtn'), stopBtn = $('#stopBtn'), codeEl = $('#code');
const outputEl = $('#output'), previewFrame = $('#preview'), htmlPreview = $('#htmlPreview'), previewMode = $('#previewMode');
const fileInput = $('#fileInput'), uploadBtn = $('#uploadBtn'), saveAsEl = $('#saveAs'), saveBtn = $('#saveBtn');
const filesListEl = $('#filesList'), filePreview = $('#filePreview'), searchEl = $('#search');
const exportBtn = $('#exportBtn'), importBtn = $('#importBtn'), importFile = $('#importFile'), downloadSelected = $('#downloadSelected'), importToLocalBtn = $('#importToLocal'), remoteStatus = $('#remoteStatus');
const calcInput = $('#calcInput'), opsDiv = $('#ops'), calcEval = $('#calcEval'), calcClear = $('#calcClear'), calcResult = $('#calcResult');
const chatMsg = $('#chatMsg'), chatSend = $('#chatSend'), chatClear = $('#chatClear'), chatResp = $('#chatResp');
const jsonbinKeyEl = $('#jsonbinKey'), jsonbinBinEl = $('#jsonbinBinId'), judge0HostInput = $('#judge0Host'), judge0KeyInput = $('#judge0Key'), openaiKeyInput = $('#openaiKey');
const btnLoadRemote = $('#btnLoadRemote'), btnClearLocal = $('#btnClearLocal');

let sidebarOpen = false;
let localIndex = JSON.parse(localStorage.getItem('vorie_index_v1')||'[]'); // {id,fileName,fileType,savedAt,code,jsonbinId,judge0Id}
let selectedFileId = null;
let remoteCache = []; // holds remote JSONBin items when loaded

/* Sidebar toggle */
function setSidebar(open){
  sidebarOpen = !!open;
  if(sidebarOpen){ sidebar.classList.add('open'); content.classList.add('shift'); sidebar.setAttribute('aria-hidden','false'); }
  else { sidebar.classList.remove('open'); content.classList.remove('shift'); sidebar.setAttribute('aria-hidden','true'); }
}
hamburger.addEventListener('click', ()=> setSidebar(!sidebarOpen));
document.addEventListener('click', (e)=>{ if(window.innerWidth <= 880 && sidebarOpen){ if(!e.composedPath().includes(sidebar) && !e.composedPath().includes(hamburger)) setSidebar(false); } });

/* View switching (Mode B: header fixed, content replaced) */
function showView(name){
  Object.keys(views).forEach(k => views[k].style.display = 'none');
  if(views[name]) views[name].style.display = 'block';
  menuButtons.forEach(b => b.classList.toggle('active', b.dataset.section === name));
  // auto-close on mobile
  if(window.innerWidth <= 880) setSidebar(false);
  // focus certain controls
  if(name === 'editor') codeEl.focus();
  if(name === 'files') searchEl.focus();
}
menuButtons.forEach(b => b.addEventListener('click', ()=> showView(b.dataset.section)));
showView('editor'); // default

/* Persist index */
function persistIndex(){ localStorage.setItem('vorie_index_v1', JSON.stringify(localIndex)); renderFiles(searchEl.value); }

/* Render files list (local + remote indicator) */
function renderFiles(q=''){
  const query = (q||'').toLowerCase();
  filesListEl.innerHTML = '';
  const items = localIndex.filter(it => !query || (it.fileName && it.fileName.toLowerCase().includes(query)) || (it.fileType && it.fileType.toLowerCase().includes(query)));
  if(items.length === 0){
    filesListEl.innerHTML = '<div class="small">Tidak ada file lokal yang cocok.</div>';
  } else {
    items.forEach(it => {
      const div = document.createElement('div'); div.className = 'file-item';
      div.innerHTML = `<div style="flex:1"><div style="font-weight:600">${esc(it.fileName)}.${esc(it.fileType)}</div><div class="small">${it.savedAt}${it.jsonbinId?(' • jsonbin'):"" }${it.judge0Id?(' • judge0'):""}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn-load btn" data-id="${it.id}">Load</button>
          <button class="btn-dl btn" data-id="${it.id}">DL</button>
          <button class="btn-del btn" data-id="${it.id}">Del</button>
        </div>`;
      filesListEl.appendChild(div);
    });
    // handlers
    $$('.btn-load').forEach(b => b.onclick = () => { const it = localIndex.find(x=>x.id===b.dataset.id); if(!it) return; selectedFileId = it.id; filePreview.textContent = it.code; codeEl.value = it.code; toast('Loaded ' + it.fileName + '.' + it.fileType); showView('files'); });
    $$('.btn-dl').forEach(b => b.onclick = () => { const it = localIndex.find(x=>x.id===b.dataset.id); if(!it) return; downloadText(it.code, `${it.fileName}.${it.fileType}`); });
    $$('.btn-del').forEach(b => b.onclick = () => { if(!confirm('Hapus dari index lokal?')) return; localIndex = localIndex.filter(x=>x.id!==b.dataset.id); persistIndex(); });
  }

  // render remote search results below local (if any)
  if(remoteCache && remoteCache.length){
    const header = document.createElement('div'); header.className='small'; header.style.marginTop='12px'; header.textContent = 'Remote (jsonbin)';
    filesListEl.appendChild(header);
    remoteCache.filter(r => !query || (r.fileName && r.fileName.toLowerCase().includes(query)) || (r.fileType && r.fileType.toLowerCase().includes(query))).forEach((r, idx) => {
      const div = document.createElement('div'); div.className='file-item';
      div.innerHTML = `<div style="flex:1"><div style="font-weight:600">${esc(r.fileName)}.${esc(r.fileType)}</div><div class="small">${r.savedAt}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn-import btn" data-idx="${idx}">Import</button>
          <button class="btn-preview btn" data-idx="${idx}">Preview</button>
        </div>`;
      filesListEl.appendChild(div);
    });
    $$('.btn-import').forEach(b => b.onclick = async () => {
      const idx = Number(b.dataset.idx); const r = remoteCache[idx];
      if(!r) return alert('Remote item not found');
      // import into local
      const item = { id: randId(), fileName: r.fileName||('file-'+Date.now()), fileType: r.fileType||'txt', savedAt: r.savedAt||new Date().toISOString(), code: r.code||'', jsonbinId: jsonbinBinEl.value.trim()||JSONBIN_BIN_ID||null, judge0Id: null };
      localIndex.unshift(item); persistIndex(); toast('Imported remote to local: '+item.fileName+'.'+item.fileType);
    });
    $$('.btn-preview').forEach(b => b.onclick = () => { const r = remoteCache[Number(b.dataset.idx)]; if(!r) return; filePreview.textContent = r.code||'(no code)'; selectedFileId = null; });
  }
}

/* Helpers */
function downloadText(text, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text], {type:'text/plain'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

/* Search local + remote on input (remote only if configured) */
searchEl.addEventListener('input', async () => {
  const q = searchEl.value.trim();
  // if remote configured, fetch remote records and cache
  const mk = jsonbinKeyEl.value.trim() || JSONBIN_MASTER_KEY || '';
  const bin = jsonbinBinEl.value.trim() || JSONBIN_BIN_ID || '';
  if(mk && bin){
    remoteStatus.textContent = 'Fetching...';
    try{
      const j = await jsonbinGet(bin, mk);
      const arr = j.record && Array.isArray(j.record) ? j.record : [];
      // normalize remoteCache
      remoteCache = arr.map(r => ({ code: r.code||'', fileType: r.fileType||'txt', fileName: r.fileName||'untitled', savedAt: r.savedAt||'' }));
      remoteStatus.textContent = 'Remote loaded: ' + remoteCache.length;
    }catch(err){ remoteCache = []; remoteStatus.textContent = 'Remote error'; }
  } else {
    remoteCache = [];
    remoteStatus.textContent = 'No remote configured';
  }
  renderFiles(q);
});

/* Upload button — save local, auto remote (jsonbin), auto judge0 submission */
uploadBtn.addEventListener('click', async () => {
  const f = fileInput.files[0]; if(!f) return alert('Pilih file dulu.');
  const code = await f.text(); const parts = f.name.split('.'); const ext = parts.length>1?parts.pop():'txt'; const nameOnly = parts.join('.')||'file';
  const item = { id: randId(), fileName: nameOnly, fileType: ext, savedAt: new Date().toISOString(), code, jsonbinId:null, judge0Id:null };
  localIndex.unshift(item); persistIndex(); toast('Saved locally: ' + nameOnly + '.' + ext);

  // Auto save to jsonbin if configured
  const mk = jsonbinKeyEl.value.trim() || JSONBIN_MASTER_KEY || '';
  const bin = jsonbinBinEl.value.trim() || JSONBIN_BIN_ID || '';
  if(mk && bin){
    try{
      // fetch existing array, append, put back
      let existing = [];
      try{ const res = await jsonbinGet(bin, mk); existing = res.record && Array.isArray(res.record) ? res.record : []; } catch(e){ existing = []; }
      existing.push({ code: item.code, fileType: item.fileType, fileName: item.fileName, savedAt: item.savedAt });
      await jsonbinPut(bin, mk, existing);
      item.jsonbinId = bin; persistIndex();
      toast('Auto-saved to JsonBin (bin='+bin+')');
    }catch(err){ toast('JsonBin save failed: ' + err.message); }
  }

  // Auto submit to Judge0 (optional) — create submission and store token/id
  const judgeHost = judge0HostInput.value.trim() || JUDGE0_HOST || '';
  const judgeKey = judge0KeyInput.value.trim() || JUDGE0_KEY || '';
  if(judgeHost){
    try{
      // base64 encode source
      const b64 = btoa(unescape(encodeURIComponent(item.code)));
      // default language: map by extension (quick)
      const langIdMap = { c:50, cpp:54, java:62, python:71, js:63 }; // common Judge0 ids (may differ per instance)
      const language_id = langIdMap[item.fileType] || 54;
      const url = judgeHost.replace(/\/$/, '') + '/submissions?base64_encoded=true';
      const headers = { 'Content-Type':'application/json' };
      if(judgeKey) headers['X-RapidAPI-Key'] = judgeKey;
      const body = JSON.stringify({ language_id, source_code: b64 });
      // create submission (without wait to get token)
      const res = await fetch(url, { method:'POST', headers, body });
      const j = await res.json();
      // judge0 returns token or id; store it
      const token = j.token || j.id || (j && j.data && j.data.id) || null;
      if(token){ item.judge0Id = token; persistIndex(); toast('Submitted to Judge0 (token saved)'); }
    }catch(err){ console.warn('judge0 submit failed', err); toast('Judge0 submit failed: ' + err.message); }
  }
});

/* Save button (manual save + remote + judge0) */
saveBtn.addEventListener('click', async () => {
  const nameRaw = saveAsEl.value.trim(); if(!nameRaw) return alert('Isi nama file ex: hello.cpp');
  const parts = nameRaw.split('.'); if(parts.length<2) return alert('Nama harus mengandung ekstensi');
  const ext = parts.pop(); const nameOnly = parts.join('.');
  const code = codeEl.value;
  const item = { id: randId(), fileName:nameOnly, fileType:ext, savedAt:new Date().toISOString(), code, jsonbinId:null, judge0Id:null };
  localIndex.unshift(item); persistIndex(); toast('Simpan lokal: ' + nameOnly + '.' + ext);

  // Auto jsonbin
  const mk = jsonbinKeyEl.value.trim() || JSONBIN_MASTER_KEY || '';
  const bin = jsonbinBinEl.value.trim() || JSONBIN_BIN_ID || '';
  if(mk && bin){
    try{
      let existing = [];
      try{ const r = await jsonbinGet(bin, mk); existing = r.record && Array.isArray(r.record) ? r.record : []; } catch(e){ existing = []; }
      existing.push({ code: item.code, fileType: item.fileType, fileName: item.fileName, savedAt: item.savedAt });
      await jsonbinPut(bin, mk, existing);
      item.jsonbinId = bin; persistIndex(); toast('Saved to JsonBin');
    }catch(err){ toast('JsonBin save failed: ' + err.message); }
  }

  // Judge0 submit (optional)
  const judgeHost = judge0HostInput.value.trim() || JUDGE0_HOST || '';
  const judgeKey = judge0KeyInput.value.trim() || JUDGE0_KEY || '';
  if(judgeHost){
    try{
      const b64 = btoa(unescape(encodeURIComponent(item.code)));
      const langIdMap = { c:50, cpp:54, java:62, python:71, js:63 };
      const language_id = langIdMap[item.fileType] || 54;
      const url = judgeHost.replace(/\/$/, '') + '/submissions?base64_encoded=true';
      const headers = { 'Content-Type':'application/json' };
      if(judgeKey) headers['X-RapidAPI-Key'] = judgeKey;
      const res = await fetch(url, { method:'POST', headers, body: JSON.stringify({ language_id, source_code: b64 }) });
      const j = await res.json();
      const token = j.token || j.id || null;
      if(token){ item.judge0Id = token; persistIndex(); toast('Submitted to Judge0 (token saved)'); }
    }catch(err){ toast('Judge0 submit failed: ' + err.message); }
  }
});

/* Export / Import */
exportBtn.addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(localIndex,null,2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'vorie-index.json'; a.click(); a.remove();
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', ()=> {
  const f = importFile.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = e => {
    try{ const arr = JSON.parse(e.target.result); if(Array.isArray(arr)){ localIndex = arr.concat(localIndex); persistIndex(); alert('Import sukses'); } else alert('Format tidak valid'); } catch(err){ alert('Import error: '+err.message); }
  }; r.readAsText(f);
});

/* Download selected / import remote to local */
downloadSelected.addEventListener('click', ()=> {
  if(!selectedFileId) return alert('Pilih file lokal dulu (klik Load pada list).');
  const it = localIndex.find(x=>x.id===selectedFileId); if(!it) return;
  downloadText(it.code, `${it.fileName}.${it.fileType}`);
});
importToLocalBtn.addEventListener('click', ()=> {
  // if filePreview contains remote code and selectedFileId is null, import last previewed remote
  // simple: if remoteCache length and filePreview contains remote code, push first matching remote
  const previewText = filePreview.textContent;
  const found = remoteCache.find(r => r.code === previewText);
  if(!found) return alert('Preview bukan remote item atau tidak ada.');
  const item = { id: randId(), fileName: found.fileName||('file-'+Date.now()), fileType: found.fileType||'txt', savedAt: new Date().toISOString(), code: found.code, jsonbinId: jsonbinBinEl.value.trim()||JSONBIN_BIN_ID||null, judge0Id: null };
  localIndex.unshift(item); persistIndex(); toast('Imported preview -> local');
});

/* Search remote helper triggered by settings button or search */
async function loadRemoteIndexNow(){
  const mk = jsonbinKeyEl.value.trim() || JSONBIN_MASTER_KEY || '';
  const bin = jsonbinBinEl.value.trim() || JSONBIN_BIN_ID || '';
  if(!mk || !bin) return alert('Isi JSONBIN key + BIN ID di Settings dulu.');
  remoteStatus.textContent = 'Loading...';
  try{
    const j = await jsonbinGet(bin, mk);
    const arr = j.record && Array.isArray(j.record) ? j.record : [];
    remoteCache = arr.map(r => ({ code: r.code||'', fileType: r.fileType||'txt', fileName: r.fileName||'untitled', savedAt: r.savedAt||'' }));
    remoteStatus.textContent = 'Loaded ' + remoteCache.length;
    renderFiles(searchEl.value);
  }catch(err){ remoteStatus.textContent = 'Remote error'; alert('Load remote failed: '+err.message); }
}
btnLoadRemote.addEventListener('click', loadRemoteIndexNow);

/* Clear local */
btnClearLocal.addEventListener('click', ()=> { if(confirm('Clear local index?')){ localIndex = []; persistIndex(); alert('Cleared'); } });

/* JSONBIN API helpers */
async function jsonbinGet(binId, masterKey){
  const url = `https://api.jsonbin.io/v3/b/${binId}`;
  const res = await fetch(url, { headers: { 'X-Master-Key': masterKey } });
  if(!res.ok) throw new Error('jsonbin get failed ' + res.status);
  return await res.json();
}
async function jsonbinPut(binId, masterKey, record){
  const url = `https://api.jsonbin.io/v3/b/${binId}`;
  const res = await fetch(url, { method:'PUT', headers:{ 'Content-Type':'application/json','X-Master-Key': masterKey }, body: JSON.stringify(record) });
  if(!res.ok) throw new Error('jsonbin put failed ' + res.status);
  return await res.json();
}
async function jsonbinPost(masterKey, record){
  const url = `https://api.jsonbin.io/v3/b`;
  const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json','X-Master-Key': masterKey }, body: JSON.stringify(record) });
  if(!res.ok) throw new Error('jsonbin post failed ' + res.status);
  return await res.json();
}

/* Calculator setup */
const calcOps = ['+','-','*','/','%','^','sqrt(','sin(','cos(','tan(','log(','ln('];
calcOps.forEach(op => { const b=document.createElement('button'); b.textContent=op; b.className='btn'; b.onclick=()=>{ calcInput.value += op; }; opsDiv.appendChild(b); });
calcEval.addEventListener('click', async ()=> {
  const expr = calcInput.value.trim(); if(!expr) return;
  try{ if(!window.math) await loadScript('https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js'); calcResult.textContent = String(math.evaluate(expr)); } catch(err){ calcResult.textContent = 'Error: ' + err.message; }
});
calcClear.addEventListener('click', ()=> { calcInput.value=''; calcResult.textContent='—'; });

/* ChatGPT (direct) */
chatSend.addEventListener('click', async ()=> {
  const mk = openaiKeyInput.value.trim() || OPENAI_API_KEY || '';
  const prompt = chatMsg.value.trim(); if(!prompt) return alert('Tulis prompt dulu');
  if(!mk) return alert('Masukkan OpenAI API key di Settings atau di script constants');
  chatResp.textContent = 'Loading...';
  try{
    const res = await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+mk }, body: JSON.stringify({ model:'gpt-4o-mini', messages:[{role:'user', content:prompt}], max_tokens:800 })});
    const j = await res.json();
    if(j.error){ chatResp.textContent = 'Error: ' + JSON.stringify(j.error); return; }
    const out = (j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content) ? j.choices[0].message.content : JSON.stringify(j);
    chatResp.textContent = out;
  }catch(err){ chatResp.textContent = 'Request error: ' + err.message; }
});
chatClear.addEventListener('click', ()=> { chatMsg.value=''; chatResp.textContent='—'; });

/* Run / compile logic */
let pyodide = null, pyReady = false;
async function ensurePyodide(){ if(pyReady) return await loadScript('https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js').then(()=>loadPyodide({ indexURL:'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' })).then(p=>{pyodide=p;pyReady=true;}); }

runBtn.addEventListener('click', async ()=> {
  const lang = langEl.value; const code = codeEl.value;
  outputEl.textContent = 'Running...'; htmlPreview.style.display = 'none';
  if(lang === 'html' || previewMode.value === 'html'){ htmlPreview.style.display='block'; const doc = previewFrame.contentDocument || previewFrame.contentWindow.document; doc.open(); doc.write(code); doc.close(); outputEl.textContent='HTML rendered'; return; }
  if(lang === 'js'){ outputEl.textContent='$Console Vorie'; const iframe = document.createElement('iframe'); iframe.style.display='none'; document.body.appendChild(iframe); window.addEventListener('message', function onMsg(e){ if(e.data && e.data.type==='v_console') outputEl.textContent += '\n'+e.data.msg; }, { once:false }); const wrapped = `<script>(function(){const send=(t)=>parent.postMessage({type:'v_console', msg:t}, '*');console.log=function(){send(Array.from(arguments).join(' '));};console.error=function(){send('ERR:'+Array.from(arguments).join(' '));};try{${code}}catch(e){send('Exception:'+e);}})() </script>`
  iframe.srcdoc = wrapped; setTimeout(()=>iframe.remove(),9000); return; }
  if(lang === 'python'){ try{ await ensurePyodide(); outputEl.textContent='Running Python...'; let out=[]; pyodide.setStdout({batched:false, stdout:s=>out.push(s)}); pyodide.setStderr({batched:false, stderr:s=>out.push('ERR:'+s)}); await pyodide.runPythonAsync(code); outputEl.textContent = out.join('\n')||'(no output)'; }catch(err){ outputEl.textContent='Py error: '+(err.message||err); } return; }
  // compiled languages -> Wandbox fallback
  const compilerMap = { c:'gcc-head', cpp:'gcc-head', java:'openjdk-head' };
  const comp = compilerMap[lang] || 'gcc-head';
  const payload = { code, compiler: comp, options:'warning', runtime:'true' };
  try{ const res = await fetch('https://wandbox.org/api/compile.json',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); const j = await res.json(); const out = j.program_output||j.compiler_output||j.status||JSON.stringify(j); outputEl.textContent = out; }catch(err){ outputEl.textContent = 'Compile/run error: ' + err.message; }
});

/* Helper: map ext */
function mapExt(ext){ ext = (ext||'').toLowerCase(); if(ext==='c') return 'c'; if(ext==='cpp'||ext==='cc'||ext==='cxx') return 'cpp'; if(ext==='py') return 'python'; if(ext==='js') return 'js'; if(ext==='java') return 'java'; return 'cpp'; }

/* Load remote index automatically on start if configured */
setTimeout(()=> { const mk = jsonbinKeyEl.value.trim() || JSONBIN_MASTER_KEY || ''; const bin = jsonbinBinEl.value.trim() || JSONBIN_BIN_ID || ''; if(mk && bin) loadRemoteIndexNow().catch(()=>{}); }, 1200);

/* Init demo item if no local */
if(!localIndex.length){ localIndex.push({ id:randId(), fileName:'hello', fileType:'cpp', savedAt:new Date().toISOString(), code: codeEl.value, jsonbinId:null, judge0Id:null }); persistIndex(); }

/* Keyboard shortcuts */
document.addEventListener('keydown', e => { if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); runBtn.click(); } if((e.ctrlKey||e.metaKey) && e.key==='s'){ e.preventDefault(); saveAsEl.value = saveAsEl.value || ('code-'+Date.now()+'.txt'); saveBtn.click(); } });

/* loadScript util */
function loadScript(src){ return new Promise((res,rej)=>{ if(document.querySelector('script[src="'+src+'"]')) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

/* JSONBIN & Judge0 placeholders (constants) */
const JSONBIN_MASTER_KEY = "$2a$10$uhPFnk0pdepYzFx.QGqgueqBn0ACjHz28cQ7icJGrJT7XPa0ciIge";
const JSONBIN_BIN_ID = "690fd893ae596e708f4d2d2c";
const JUDGE0_HOST = "console-vorie.p.rapidapi.com"; // jika mau default
const JUDGE0_KEY = "ca42f31774msh7600ed543ac9995p1b02dajsn068052506cfd"; // RapidAPI key (optional)
const OPENAI_API_KEY = "GANTI_KEY_OPENAI_DI_SINI";

/* Small helper logs */
console.log('VORIE Online IDE — We Build For Sell');

/* End of script */
</script>
</body>
</html>
